# Sample HAProxy Configuration for Migration Testing
# This demonstrates common HAProxy patterns that Prism can migrate

global
    log /dev/log local0
    log /dev/log local1 notice
    maxconn 4096
    user haproxy
    group haproxy
    daemon

    # SSL settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 60s
    balance roundrobin

# Frontend for HTTP (redirect to HTTPS)
frontend http_front
    bind *:80
    mode http
    redirect scheme https code 301 if !{ ssl_fc }

# Frontend for HTTPS
frontend https_front
    bind *:443 ssl crt /etc/ssl/certs/example.pem alpn h2,http/1.1
    mode http

    # Set headers
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Real-IP %[src]

    # ACLs for routing
    acl is_api path_beg /api
    acl is_ws path_beg /ws
    acl is_static path_beg /static
    acl is_health path /health
    acl is_internal hdr(host) -i internal.example.com

    # Use backends based on ACLs
    use_backend api_servers if is_api
    use_backend ws_servers if is_ws
    use_backend static_servers if is_static
    use_backend health_backend if is_health

    # Default backend
    default_backend api_servers

# Backend for API
backend api_servers
    mode http
    balance leastconn
    option httpchk GET /health
    http-check expect status 200

    # Cookie-based session affinity
    cookie SERVERID insert indirect nocache

    server api1 10.0.0.1:3000 weight 5 check cookie api1
    server api2 10.0.0.2:3000 weight 3 check cookie api2
    server api3 10.0.0.3:3000 backup check cookie api3

# Backend for WebSocket
backend ws_servers
    mode http
    balance source
    option http-server-close
    timeout tunnel 1h

    server ws1 10.0.1.1:8080 check
    server ws2 10.0.1.2:8080 check

# Backend for static content
backend static_servers
    mode http
    balance roundrobin

    server static1 10.0.2.1:80 check
    server static2 10.0.2.2:80 check

# Health check backend
backend health_backend
    mode http
    server local 127.0.0.1:8081

# Listen section (combined frontend + backend)
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:password

# TCP mode example (for databases)
listen mysql
    bind *:3306
    mode tcp
    balance roundrobin
    option mysql-check user haproxy
    timeout client 1h
    timeout server 1h

    server mysql1 10.0.3.1:3306 check
    server mysql2 10.0.3.2:3306 check backup
